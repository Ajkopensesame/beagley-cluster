<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cluster Map</title>

    <!-- MapLibre (CDN for v1 prototype) -->
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

    <style>
      html, body { height: 100%; margin: 0; background: #000; overflow: hidden; }
      #map { position: absolute; inset: 0; }
      .hud {
        position: absolute;
        left: 12px; top: 12px;
        color: #fff;
        font: 13px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background: rgba(0,0,0,0.45);
        padding: 8px 10px;
        border-radius: 10px;
        user-select: none;
        pointer-events: none;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <div class="hud" id="hud">MapLibre loading…</div>

    <script>
      // Simple raster style using OpenStreetMap tiles.
      // NOTE: For production you should NOT hammer public OSM tiles from a fleet.
      // We will replace this with offline/hosted tiles later.
      const rasterStyle = {
        "version": 8,
        "sources": {
          "osm": {
            "type": "raster",
            "tiles": [
              "https://tile.openstreetmap.org/{z}/{x}/{y}.png"
            ],
            "tileSize": 256,
            "attribution": "© OpenStreetMap contributors"
          }
        },
        "layers": [
          { "id": "osm", "type": "raster", "source": "osm" }
        ]
      };

      // Start position: Brisbane-ish (replace later with GPS)
      let current = { lng: 153.0251, lat: -27.4698, zoom: 12.2, bearing: 0 };

      const map = new maplibregl.Map({
        container: "map",
        style: rasterStyle,
        center: [current.lng, current.lat],
        zoom: current.zoom,
        bearing: current.bearing,
        pitch: 0,
        attributionControl: false
      });

      map.addControl(new maplibregl.AttributionControl({ compact: true }), "bottom-right");
      map.addControl(new maplibregl.NavigationControl({ showCompass: false }), "top-right");

      const hud = document.getElementById("hud");

      map.on("load", () => {
        hud.textContent = "MapLibre loaded ✅";
      });

      // Hook for QML later: you can call this from WebChannel or evaluateJavaScript
      window.setVehiclePose = function(lat, lng, bearingDeg, zoom) {
        if (typeof zoom === "number") current.zoom = zoom;
        current.lat = lat; current.lng = lng;
        current.bearing = (typeof bearingDeg === "number") ? bearingDeg : current.bearing;

        map.easeTo({
          center: [current.lng, current.lat],
          bearing: current.bearing,
          duration: 250
        });

        hud.textContent = `GPS: ${current.lat.toFixed(5)}, ${current.lng.toFixed(5)}  b:${Math.round(current.bearing)}°`;
      };

      // Demo motion so you can see it moving without GPS
      let t = 0;
      setInterval(() => {
        t += 0.00025;
        const lat = current.lat + Math.sin(t) * 0.0003;
        const lng = current.lng + Math.cos(t) * 0.0003;
        const bearing = (current.bearing + 1.2) % 360;
        window.setVehiclePose(lat, lng, bearing);
      }, 250);
    </script>
  </body>
</html>
